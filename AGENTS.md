# AGENTS.md - NixOS System Configurations

This document provides essential context for AI agents working on this NixOS/nix-darwin system configuration repository.

## Project Overview

This is a **NixOS/nix-darwin system configuration repository** that manages complete system configurations for multiple machines and environments using the Nix language.

**Supported Platforms:**
- **NixOS VM** (primary) - Linux development environment running on macOS host via VMware Fusion
- **macOS** - Host system configuration via nix-darwin
- **WSL** - Windows Subsystem for Linux for Windows environments

**Philosophy:** Use macOS for graphical applications (browser, messaging, etc.) and NixOS VM for all development work. A single codebase configures all three platforms with appropriate conditional logic.

## Multi-Platform Architecture

### How It Works

The `lib/mksystem.nix` function is the core abstraction that enables multi-platform support. It takes a machine name and configuration options, then assembles the appropriate modules based on the target platform.

```
flake.nix
  │
  ├── mkSystem "vm-aarch64" { system = "aarch64-linux"; }     → NixOS VM (ARM)
  ├── mkSystem "vm-intel" { system = "x86_64-linux"; }        → NixOS VM (Intel)
  ├── mkSystem "wsl" { system = "x86_64-linux"; wsl = true; } → WSL
  └── mkSystem "macbook-pro-m1" { darwin = true; }            → macOS
```

### Platform Detection Mechanism

In `lib/mksystem.nix`, platform flags determine which modules and configurations to apply:

```nix
# Boolean flags derived from mkSystem arguments
isWSL = wsl;                    # WSL-specific behavior
isLinux = !darwin && !isWSL;    # Full Linux (VM with GUI)
darwin = darwin;                # macOS via nix-darwin

# Platform-specific function selection
systemFunc = if darwin
  then inputs.darwin.lib.darwinSystem
  else nixpkgs.lib.nixosSystem;
```

These flags are passed to modules via `config._module.args` and to home-manager, enabling conditional configuration throughout the codebase.

### Conditional Configuration Patterns

**In `home-manager.nix`** - use `pkgs.stdenv` for package-level conditionals:
```nix
isDarwin = pkgs.stdenv.isDarwin;
isLinux = pkgs.stdenv.isLinux;

home.packages = [
  pkgs.common-package
] ++ (lib.optionals isDarwin [ pkgs.mac-only ])
  ++ (lib.optionals (isLinux && !isWSL) [ pkgs.gui-linux-only ]);
```

**In machine configs** - use `currentSystemName` for machine-specific overrides:
```nix
environment.systemPackages = lib.optionals (currentSystemName == "vm-aarch64") [
  pkgs.vmware-specific-package
];
```

### Platform-Specific Limitations

| Platform | Limitations & Considerations |
|----------|------------------------------|
| **NixOS VM** | Requires VMware Fusion on macOS host; shared folders mount at `/host`; uses NAT networking (IP: `192.168.58.XXX`); firewall disabled for development convenience |
| **macOS** | Uses Determinate Nix installer, so `nix.enable = false` in darwin config; Homebrew manages GUI apps via casks; some Linux-only packages unavailable |
| **WSL** | No graphical applications; builds to a tarball installer; limited systemd support; filesystem mounted at `/mnt` |

### What Each Platform Gets

| Component | VM (Linux) | macOS | WSL |
|-----------|------------|-------|-----|
| **Window Manager** | Niri/Mango (Wayland) | Native macOS | None |
| **Terminal** | Ghostty, foot | Native + iTerm2 | Windows Terminal |
| **Package Manager** | Nix only | Nix + Homebrew | Nix only |
| **GUI Apps** | Firefox, Chromium | Via Homebrew casks | None |
| **Display Manager** | greetd + tuigreet | N/A | N/A |
| **Input Method** | fcitx5 | Native | N/A |
| **Docker** | Native | Docker Desktop | Docker Desktop |

## Directory Structure

| Directory | Purpose |
|-----------|---------|
| `/lib/` | Core library functions - contains `mksystem.nix` which is the main system builder |
| `/machines/` | Machine-specific configurations (VM, MacBook, WSL) |
| `/machines/hardware/` | Hardware-specific configurations (auto-generated by `nixos-generate-config`) |
| `/modules/` | Reusable NixOS modules |
| `/modules/specialization/` | System specializations (alternative desktop environments, e.g., GNOME+ibus) |
| `/users/` | Per-user home-manager and OS-specific configurations |
| `/users/m/` | User "m" configurations (home-manager, dotfiles, shell configs) |
| `/docs/` | Documentation and helper scripts |
| `/.github/` | GitHub workflows (GitHub Pages deployment) |
| `/.claude/` | Claude-specific settings |

### User Configuration Files (in `/users/m/`)

| File | Purpose |
|------|---------|
| `home-manager.nix` | Main home-manager config - packages, programs, dotfiles (shared across platforms) |
| `nixos.nix` | NixOS-specific user settings (user account, groups, shell) - used by VM and WSL |
| `darwin.nix` | macOS-specific settings (Homebrew apps, user shell) |
| `ghostty.linux` | Ghostty terminal configuration for Linux |
| `bashrc`, `inputrc`, `gdbinit` | Shell and tool configurations |

## Build Commands (Makefile)

| Command | Description |
|---------|-------------|
| `make switch` | Apply the NixOS/nix-darwin configuration to the current system |
| `make test` | Test the configuration without applying it permanently |
| `make vm/provision` | Provision a fresh VM from a live ISO (partition, format, install) |
| `make vm/copy` | Copy Nix configurations to a running VM |
| `make vm/switch` | Run `nixos-rebuild switch` on the remote VM |
| `make vm/update` | Combined copy + switch for VM (uses VMware Fusion to get IP) |
| `make vm/secrets` | Copy SSH keys and GPG keyring to VM |
| `make wsl` | Build a WSL root tarball installer |
| `make secrets/backup` | Backup SSH and GPG keys to `backup.tar.gz` |
| `make secrets/restore` | Restore SSH and GPG keys from `backup.tar.gz` |

**Environment Variables for VM Operations:**
- `NIXADDR` - IP address of the target VM
- `NIXPORT` - SSH port (default: 22)
- `NIXUSER` - Username (default: m)
- `NIXNAME` - Configuration name (default: vm-aarch64)

## Key Configuration Files

| File | Purpose |
|------|---------|
| `flake.nix` | Main entry point - defines all system configurations and inputs |
| `flake.lock` | Locked versions of all flake inputs (dependencies) |
| `Makefile` | Build automation and VM management commands |
| `lib/mksystem.nix` | System builder function - creates NixOS/darwin configurations |
| `machines/vm-shared.nix` | Shared VM configuration (Wayland, Niri, Docker, etc.) |
| `machines/vm-aarch64.nix` | ARM64 VM configuration (VMware Fusion) |
| `machines/macbook-pro-m1.nix` | macOS configuration via nix-darwin |
| `machines/wsl.nix` | WSL-specific configuration |

## External Dependencies (Flake Inputs)

| Input | Channel | Purpose |
|-------|---------|---------|
| `nixpkgs` | 25.11 (stable) | Primary package source - most packages come from here |
| `nixpkgs-unstable` | unstable | Bleeding-edge packages (gh, claude-code) |
| `nixpkgs-master` | master | Testing only - extremely unstable |
| `home-manager` | nightly | User environment management |
| `darwin` | 25.11 | macOS system management |
| `nixos-wsl` | - | WSL support |
| `niri` | - | Scrollable-tiling Wayland compositor |
| `mangowc` | - | Alternative Wayland compositor |
| `neovim-nightly-overlay` | - | Bleeding-edge Neovim |
| `rust-overlay` | - | Rust toolchain management |
| `ghostty` | - | Terminal emulator |

**Channel Strategy:**
- Use `nixpkgs` (stable) for most packages - reliability over freshness
- Use `nixpkgs-unstable` when stable has bugs or you need recent features
- Define overrides in `flake.nix` overlays section, not scattered throughout configs

## Nix Patterns Used in This Codebase

### Common Idioms

```nix
# Conditional list append
packages = [ pkgs.always ] ++ (lib.optionals condition [ pkgs.sometimes ]);

# Conditional attribute set merge
config = { always = true; } // (if condition then { sometimes = true; } else {});

# lib.mkIf for module options (preferred in NixOS modules)
services.foo.enable = lib.mkIf isLinux true;

# Reading external files
home.file.".config/foo".text = builtins.readFile ./foo-config;
```

### Module Arguments

These are available in machine and user configs via `config._module.args`:
- `currentSystem` - e.g., `"aarch64-linux"`, `"aarch64-darwin"`
- `currentSystemName` - e.g., `"vm-aarch64"`, `"macbook-pro-m1"`
- `currentSystemUser` - e.g., `"m"`
- `isWSL` - boolean
- `inputs` - all flake inputs

## Debugging and Troubleshooting

### Useful Commands

```bash
# Evaluate a specific configuration without building
nix eval .#nixosConfigurations.vm-aarch64.config.networking.hostName

# Open a REPL with the flake loaded
nix repl .#nixosConfigurations.vm-aarch64

# Check flake for errors
nix flake check

# Show what would be built/changed
nixos-rebuild dry-run --flake .#vm-aarch64

# Build without switching (outputs to ./result)
nixos-rebuild build --flake .#vm-aarch64

# Show derivation details
nix derivation show .#nixosConfigurations.vm-aarch64.config.system.build.toplevel

# List available outputs
nix flake show
```

### Common Errors and Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| `error: attribute 'X' missing` | Typo in option name or missing import | Check spelling; verify the module providing the option is imported |
| `infinite recursion encountered` | Circular dependency in config | Avoid referencing `config` in the same expression that defines it; use `lib.mkIf` |
| `collision between X and Y` | Two packages provide the same file | Use `lib.hiPrio` or remove one package |
| `hash mismatch in fixed-output derivation` | Upstream source changed | Run `nix flake update` or update the hash |
| `experimental feature 'flakes' is disabled` | Nix not configured for flakes | Ensure `experimental-features = nix-command flakes` is set |

### Platform-Specific Debugging

**VM not getting IP:**
```bash
# Check VMware vmnet
sudo /Applications/VMware\ Fusion.app/Contents/Library/vmnet-cli --status
```

**Darwin rebuild fails:**
```bash
# Check if nix-daemon is running (Determinate installer)
launchctl list | grep nix
```

## Common Tasks for AI Agents

### Adding a New Package

1. **Determine scope:**
   - System-wide (all users): `machines/vm-shared.nix` → `environment.systemPackages`
   - User-only: `users/m/home-manager.nix` → `home.packages`

2. **Consider platform:**
   ```nix
   home.packages = [
     pkgs.cross-platform
   ] ++ (lib.optionals isLinux [ pkgs.linux-only ])
     ++ (lib.optionals isDarwin [ pkgs.mac-only ]);
   ```

3. **Test:** `make test` or `nix build .#nixosConfigurations.<name>.config.system.build.toplevel`

### Modifying Shell Configuration

- **Aliases:** Edit `shellAliases` in `users/m/home-manager.nix`
- **Zsh settings:** Edit `programs.zsh` in same file
- **Bash settings:** Edit `programs.bash` or `users/m/bashrc`

### Adding a New Machine

1. Create `machines/<name>.nix`
2. If needed, create `machines/hardware/<name>.nix` (auto-generated by `nixos-generate-config`)
3. Add entry in `flake.nix`:
   ```nix
   nixosConfigurations.<name> = mkSystem "<name>" {
     system = "x86_64-linux";  # or aarch64-linux, aarch64-darwin
     user = "m";
     # wsl = true;   # for WSL
     # darwin = true; # for macOS
   };
   ```

### Updating Dependencies

```bash
# Update all inputs
nix flake update

# Update a specific input
nix flake lock --update-input nixpkgs
```

### Using Specializations

Specializations provide alternative boot configurations (e.g., GNOME instead of Niri):

```bash
# At boot, greetd shows available sessions
# Or switch to a specialization:
sudo nixos-rebuild switch --flake .#vm-aarch64 --specialisation gnome-ibus
```

## Desktop Environment (Linux VM)

- **Primary:** Niri (scrollable-tiling Wayland compositor) or Mango
- **Alternative:** GNOME with ibus (via specialization)
- **Display Manager:** greetd with tuigreet
- **Terminal:** Ghostty, foot
- **App Launcher:** fuzzel
- **Notifications:** mako
- **Screen Locker:** swaylock
- **Screenshots:** grim + slurp
- **Wallpaper:** waypaper + swaybg

## Development Tooling

- **Shell:** zsh with starship prompt, atuin (history), direnv
- **Editors:** Neovim (nightly), Emacs 30
- **Languages:** Rust (latest via overlay), Go, Python 3.12 + uv, Node.js 22 + fnm
- **VCS:** Git (with GPG signing), jj (Jujutsu)
- **AI Tools:** claude-code, codex

## Important Notes

1. **No lint/typecheck commands** - Validation happens through `nix flake check` or building
2. **Colemak keyboard layout** - Window manager keybindings use Colemak (n/e/i/o = left/down/up/right)
3. **VM networking** - VM uses shared networking with host; IP typically `192.168.58.XXX`
4. **User "m"** - All configurations assume username "m"
5. **Shared folders** - VM mounts host filesystem at `/host` via VMware shared folders
6. **Firewall disabled** - Intentionally disabled in VMs for easier development access
7. **Determinate Nix on macOS** - Uses Determinate installer, so `nix.enable = false` in darwin config
8. **Home-manager integration** - Integrated as a NixOS/darwin module, not standalone; uses `useGlobalPkgs = true`
